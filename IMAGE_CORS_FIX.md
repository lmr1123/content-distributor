# 图片防盗链问题说明

## 问题描述

从微信公众号提取文章时，图片URL可能无法在扩展页面中正常显示：

```
Access to image at 'http://mmbiz.qpic.cn/...' has been blocked by CORS policy
```

## 原因分析

### 什么是防盗链？

微信公众号对图片资源实施了防盗链保护：

1. **Referer 检查**：服务器检查请求的 Referer 头
2. **CORS 限制**：不返回 `Access-Control-Allow-Origin` 头
3. **域名限制**：只允许特定域名访问

### 为什么会失败？

- 扩展页面的 origin 是 `chrome-extension://xxx`
- 微信服务器不接受这个来源
- 浏览器阻止加载这些图片

## 解决方案

### 方案1：图片占位符（已实现）

**当前实现**：
- ✅ 提取图片URL列表
- ✅ 用占位符替换图片
- ✅ 显示原图URL供参考
- ✅ 提示用户需要手动上传

**效果**：
```
┌──────────────────────────────────────┐
│     📷 图片位置                       │
│  http://mmbiz.qpic.cn/...            │
│  ⚠️ 微信图片有防盗链，请手动上传      │
└──────────────────────────────────────┘
```

### 方案2：手动下载上传

**步骤**：

1. **复制图片URL**
   - 占位符中显示了原图URL
   - 复制这个链接

2. **下载图片**
   - 在浏览器新标签页打开URL
   - 右键 → 另存为图片

3. **上传到平台**
   - 在目标平台编辑器中
   - 插入本地图片

### 方案3：截图保存（推荐）

对于多图文章，更高效的方法：

1. **在微信中查看文章**
2. **逐张截图保存**
3. **在编辑器中上传**

### 方案4：使用图床（高级）

如果频繁处理图片：

1. **搭建图床**
   - 使用 OSS/CDN
   - 或使用免费图床

2. **批量下载图片**
   - 使用下载工具
   - 上传到图床

3. **替换URL**
   - 在编辑器中批量替换
   - 新URL无防盗链

## 最佳实践

### 发布前检查

1. **检查图片数量**
   - 字数统计会显示图片数量
   - 确保所有图片都处理了

2. **测试显示效果**
   - 在目标平台预览
   - 确认图片正常显示

3. **准备图片素材**
   - 提前下载好所有图片
   - 按顺序命名便于插入

### 平台差异

| 平台 | 图片处理建议 |
|------|-------------|
| 小红书 | 需手动上传，最多9张 |
| 知乎 | 支持粘贴图片 |
| 简书 | 支持 Markdown 图片 |
| 今日头条 | 建议重新上传 |
| 哔哩哔哩 | 支持拖拽上传 |

## 技术细节

### 为什么不自动转换 Base64？

**考虑因素**：

1. **文件大小**
   - Base64 会增加 33% 体积
   - 多图文章会非常大
   - 可能超过存储限制

2. **性能问题**
   - 大量 Base64 影响渲染
   - 编辑器会变慢
   - 内存占用增加

3. **实际使用**
   - 最终发布仍需上传
   - Base64 不能直接用
   - 还是需要手动处理

### 未来可能的改进

1. **集成图床API**
   - 自动上传到图床
   - 返回新URL
   - 自动替换

2. **浏览器下载**
   - 触发浏览器下载
   - 保存到本地
   - 提供批量下载

3. **剪贴板处理**
   - 自动复制图片
   - 粘贴到编辑器
   - 自动上传

## 常见问题

### Q: 为什么有些图片能显示？

A: 部分图片可能：
- 使用了 CDN 加速
- 防盗链设置较宽松
- 已被缓存

### Q: 封面图也无法加载？

A: 封面图同样有防盗链：
- 点击"更换封面"手动上传
- 或截图保存后上传

### Q: 有没有自动化方案？

A: 目前需要手动处理，原因：
- 微信防盗链严格
- 自动化可能违反 ToS
- 各平台上传方式不同

### Q: 视频也无法显示？

A: 视频处理更复杂：
- 文件更大
- 格式限制
- 已在提取时移除
- 需要单独处理

## 使用建议

### 高效工作流

1. **提取文章** → 看到占位符
2. **下载图片** → 从占位符URL下载
3. **编辑内容** → 在编辑器中调整
4. **上传图片** → 发布时上传
5. **发布内容** → 各平台发布

### 批量处理技巧

对于多篇文章：
1. 先提取所有文章
2. 批量下载所有图片
3. 统一命名整理
4. 逐篇编辑发布

---

**更新日期**: 2025-02-12
**版本**: 1.0.0
**状态**: ✅ 图片占位符方案已实现
